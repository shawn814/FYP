<!DOCTYPE html>
<html lang="en">
<!-- Target
1) Resize and movable
2) Add Shape
3) Add textbox-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drawing</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            height: 100vh;
        }

        #main,
        #content {
            height: 100%;
            width: 100%;
        }

        #nav {
            position: absolute;
            z-index: 999999;
            margin: 10px;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 10px #ccc;
        }

        #type label {
            margin: 5px;
            padding: 10px;
        }

        #nav [type="radio"] {
            display: none;
        }

        .typeActive {
            background-color: #ccc;
            border-radius: 50%;
        }

        path {
            display: block;
        }

        path.choosen {
            outline: 1px dashed blue;
            cursor: move;
        }

        [v-cloak]>* {
            display: none;
        }

        [v-cloak]::before {
            content: "Loading...";
            box-sizing: border-box;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            margin-top: -10px;
            margin-left: -10px;
            border-radius: 50%;
            border: 2px solid #ccc;
            border-top-color: #333;
            animation: spinner 0.8s linear infinite;
            text-indent: 100%;
            white-space: nowrap;
            overflow: hidden;
        }

        @keyframes spinner {
            to {
                transform: rotate(360deg);
            }
        }

        /* path:hover {
            cursor: pointer;
        } */
    </style>
</head>

<body>
    <div id="main" v-cloak>
        <div id="nav">
            <!-- Creating radio buttons -->
            <div id="type">
                <label v-for="it in types" v-bind:class="{ typeActive: type==it }">
                    <input type="radio" name="type" :value="it" v-model="type" v-on:change="menu">
                    {{it.charAt(0).toUpperCase() + it.slice(1)}}
                </label>
            </div>

        </div>
        <div id="content">
            <svg id="draw" width="100%" height="100%">
                <path id="27225ac1-c387-40a5-bfad-4a35d3ce6e86" data-id="27225ac1-c387-40a5-bfad-4a35d3ce6e86"
                    d="M 676 341 L 675 341 L 674 341 L 673 341 L 672 341 L 671 341 L 669 341 L 668 341 L 667 341 L 666 341 L 665 341 L 664 341 L 663 341 L 662 341 L 660 341 L 659 341 L 657 341 L 656 341 L 655 341 L 653 341 L 652 341 L 651 341 L 649 342 L 648 342 L 646 342 L 644 343 L 643 343 L 641 344 L 640 344 L 638 345 L 637 346 L 636 347 L 635 347 L 635 348 L 634 348 L 633 348 L 632 350 L 631 350 L 629 352 L 628 353 L 627 354 L 626 356 L 624 357 L 623 359 L 622 360 L 620 362 L 619 362 L 618 364 L 617 364 L 616 365 L 615 367 L 614 368 L 613 369 L 612 371 L 611 372 L 609 374 L 608 375 L 607 376 L 607 378 L 606 379 L 606 380 L 605 382 L 605 383 L 605 384 L 603 386 L 603 387 L 603 388 L 602 390 L 602 392 L 602 394 L 602 395 L 602 398 L 602 401 L 603 402 L 603 403 L 604 405 L 604 406 L 605 407 L 606 409 L 606 410 L 607 411 L 608 414 L 608 415 L 610 416 L 611 419 L 611 420 L 611 421 L 612 423 L 613 425 L 613 426 L 614 427 L 615 429 L 616 430 L 617 432 L 617 433 L 618 433 L 618 435 L 619 436 L 620 437 L 620 438 L 621 439 L 622 440 L 622 441 L 623 441 L 624 442 L 625 442 L 626 443 L 627 444 L 628 445 L 628 446 L 630 446 L 631 448 L 632 448 L 634 450 L 636 451 L 638 453 L 640 454 L 642 456 L 643 456 L 646 457 L 648 459 L 651 459 L 654 460 L 657 461 L 660 462 L 663 463 L 666 463 L 669 464 L 672 464 L 674 464 L 675 464 L 676 464 L 678 464 L 679 464 L 680 464 L 681 464 L 683 464 L 685 464 L 686 463 L 689 462 L 690 462 L 691 461 L 693 461 L 694 460 L 695 460 L 697 460 L 699 459 L 701 457 L 705 456 L 710 454 L 714 452 L 719 450 L 723 448 L 728 446 L 732 444 L 736 442 L 737 441 L 739 439 L 740 439 L 741 437 L 743 436 L 744 434 L 746 433 L 746 432 L 748 430 L 749 429 L 750 426 L 751 425 L 752 424 L 754 421 L 754 420 L 754 419 L 754 417 L 755 415 L 756 413 L 757 412 L 758 410 L 758 409 L 758 408 L 758 406 L 759 405 L 759 404 L 759 402 L 760 401 L 760 400 L 760 399 L 760 397 L 760 396 L 760 395 L 760 393 L 760 391 L 760 390 L 760 389 L 760 387 L 760 386 L 759 385 L 759 383 L 758 382 L 757 381 L 757 379 L 756 379 L 755 377 L 755 376 L 753 375 L 752 373 L 751 372 L 749 370 L 748 368 L 746 366 L 745 364 L 743 362 L 742 361 L 740 359 L 739 358 L 738 356 L 736 355 L 735 354 L 734 353 L 733 352 L 731 350 L 730 349 L 729 348 L 729 347 L 727 346 L 726 346 L 725 345 L 724 344 L 722 343 L 721 343 L 719 343 L 719 342 L 718 342 L 717 342 L 716 341 L 715 340 L 714 339 L 713 339 L 711 338 L 709 338 L 709 337 L 708 337 L 707 337 L 706 337 L 705 337 L 704 337 L 703 337 L 702 337 L 701 337 L 700 336 L 699 336 L 698 336 L 697 336 L 696 336 L 695 336 L 693 336 L 692 336 L 691 336 L 690 336 L 689 336 L 688 336 L 686 336 L 685 336 L 684 336 L 683 336 L 681 336 L 680 336 L 679 336 L 677 336 L 676 336 L 675 336 L 674 336 L 672 336 L 671 336 L 670 336 L 669 336 L 667 336 L 666 336 L 665 337 L 664 338 L 662 339"
                    stroke="black" stroke-width="3px" fill="none" stroke-linejoin="round" stroke-linecap="round">
                </path>
                <g id="resize_wrap">
                    <rect id="resize_nw" width="10" height="10" x="" y="" />
                    <rect id="resize_n" width="10" height="10" x="" y="" />
                    <rect id="resize_ne" width="10" height="10" x="" y="" />
                    <rect id="resize_e" width="10" height="10" x="" y="" />
                    <rect id="resize_es" width="10" height="10" x="" y="" />
                    <rect id="resize_s" width="10" height="10" x="" y="" />
                    <rect id="resize_sw" width="10" height="10" x="" y="" />
                    <rect id="resize_w" width="10" height="10" x="" y="" />
                </g>
            </svg>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/vue.js"></script>

    <script>
        let line_id = 0;
        let current_id = 0;
        let choosenId = -1;

        var app = new Vue({
            el: '#main',
            data: {
                types: ["pen", "cursor", "text", "shape"],
                type: "pen",
                code: ""
            },
            components: {

            },
            methods: {
                menu: function () {
                    if (this.type == "cursor") {
                        let clickStatus = false;
                        let cursorPosition = { x: 0, y: 0 };
                        let differentPosition = { x: 0, y: 0 };
                        let position = { x: 0, y: 0 };

                        let newX = 0;
                        let newY = 0;

                        // 
                        $('svg').off('mousedown');
                        $('svg').off('mousemove');
                        $('svg').off('mouseup');
                        $('svg').off('mouseleave');

                        let dragable = false;

                        $(document).on('keydown', function (e) {
                            if (e.keyCode == 8) {
                                if (choosenId != -1) {
                                    $(`#${choosenId}`).remove();
                                    choosenId = -1;
                                }
                            }
                        });
                        $('svg *').on('mousedown', function (e) {
                            if (e.target.tagName == "path") {
                                if (choosenId != -1) {
                                    $(`#${choosenId}`).removeClass("choosen");
                                }
                                choosenId = $(this).data('id');
                                $(`#${choosenId}`).addClass("choosen");

                                if (e.target.classList.contains('choosen')) {
                                    dragable = true;

                                    console.log($(this)[0].getBoundingClientRect());
                                    let selected_info = $(this)[0].getBoundingClientRect();

                                    $("#resize_nw").attr("x", selected_info.x - 10).attr("y", selected_info.y - 10).css("curso");
                                    $("#resize_n").attr("x", selected_info.x + (selected_info.width / 2) - 5).attr("y", selected_info.y - 10);
                                    $("#resize_ne").attr("x", selected_info.x + selected_info.width).attr("y", selected_info.y - 10);
                                    $("#resize_e").attr("x", selected_info.x + selected_info.width).attr("y", selected_info.y + (selected_info.height / 2) - 5);
                                    $("#resize_es").attr("x", selected_info.x + selected_info.width).attr("y", selected_info.y + selected_info.height);
                                    $("#resize_s").attr("x", selected_info.x + (selected_info.width / 2) - 5).attr("y", selected_info.y + selected_info.height);
                                    $("#resize_sw").attr("x", selected_info.x - 10).attr("y", selected_info.y + selected_info.height);
                                    $("#resize_w").attr("x", selected_info.x - 10).attr("y", selected_info.y + (selected_info.height / 2) - 5);
                                    
                                    var p = $(`#${choosenId}`).css('transform');
                                    console.log(p);
                                    if (p != "none") {
                                        let temp = p.split(',');
                                        position.x = parseInt(temp[4]);
                                        position.y = parseInt(temp[5]);

                                    } else {
                                        position = { x: 0, y: 0 };
                                    }
                                    cursorPosition.x = e.clientX;
                                    cursorPosition.y = e.clientY;
                                }
                            }
                        });

                        $('svg').on('mousemove', function (e) {
                            if (dragable == true) {
                                differentPosition.x = e.clientX - cursorPosition.x;
                                differentPosition.y = e.clientY - cursorPosition.y;
                                newX = position.x + differentPosition.x;
                                newY = position.y + differentPosition.y;
                                $(`#${choosenId}`).css('transform', `translate(${newX}px,${newY}px)`);
                            }
                        });

                        $('svg').on('mouseup', function (e) {
                            dragable = false;
                        });

                        $('svg').on('click', function (e) {
                            if (e.target.tagName != "path") {
                                if (choosenId != -1) {
                                    $(`#${choosenId}`).removeClass("choosen");
                                    choosenId = -1;
                                }
                            }
                        });
                    }
                    else if (this.type == "pen") {
                        // Drawing =========================================================================================
                        let drawing = false;
                        let startPosX = 0;
                        let startPosY = 0;

                        $('svg *').off('mousedown');
                        $('svg').off('mousemove');
                        $('svg').off('mouseup');
                        $('svg').off('click');
                        $(`#${choosenId}`).removeClass("choosen");
                        choosenId = -1;

                        $('svg').on('mousedown', function (e) {
                            line_id = uuidv4();
                            startPosX = e.pageX;
                            startPosY = e.pageY;
                            drawing = true;
                        });

                        $('svg').on('mousemove', function (e) {
                            if (drawing) {
                                if ($(`#${line_id}`).length == "1") {
                                    $(`#${line_id}`).attr("d", $(`#${line_id}`).attr("d") + ` L ${e.pageX} ${e.pageY}`);
                                }
                                else {
                                    let newPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                                    newPath.setAttribute('id', line_id);
                                    newPath.setAttribute('data-id', line_id);
                                    newPath.setAttribute('d', `M ${startPosX} ${startPosY} L ${e.pageX} ${e.pageY}`);
                                    newPath.setAttribute('stroke', 'black');
                                    newPath.setAttribute('stroke-width', '3px');
                                    newPath.setAttribute('fill', 'none');
                                    newPath.setAttribute('stroke-linejoin', 'round');
                                    newPath.setAttribute('stroke-linecap', 'round');

                                    $(this).append(newPath);
                                }
                                $.post('router.php', {
                                    code: $('svg').parent().html()
                                });
                            }
                        });

                        $('svg').on('mouseup', function (e) {
                            drawing = false;
                        });

                        $('svg').on('mouseleave', function (e) {
                            drawing = false;
                        });


                    }
                    else if (this.type == "text") {
                        let cursorPosition = { x: 0, y: 0 };

                        $('svg').style.cursor = "text";

                        $('svg').on('click', function (e) {
                            text_id = uuidv4();
                            textPosX = e.pageX;
                            textPosY = e.pageY;

                            let newText = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
                            newText.setAttribute()
                            //"Enter key" = 13
                        })
                    }
                    else {

                    }
                }
            },

            computed: {

            },
            created() {
                // Realtime template demo
                // if (typeof (EventSource) !== "undefined") {
                //     var source = new EventSource("router.php", {
                //         withCredentials: true
                //     });

                //     source.addEventListener('message', event => {
                //         if (this.code != event.data) {
                //             this.code = event.data;
                //             line_id = $(event.data).children().last().attr('id') > current_id ? $(event.data).children().last().attr('id') : line_id;
                //             if (line_id != current_id) $('svg').html($(this.code).html());
                //         }
                //     }, false);

                //     source.onerror = function (event) {
                //         if (event.readyState == EventSource.CLOSED) {
                //             console.log('Event was closed');
                //         } else {
                //             console.log("EventSource failed:", event);
                //         }
                //     }
                // } else {
                //     console.log("Sorry, your browser does not support server-sent events...");
                // }
            },
            mounted() {
                this.menu();
            }
        });
        function uuidv4() {
            return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }
    </script>
</body>

</html>